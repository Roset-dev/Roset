# Leases API

Leases provide distributed locking for nodes. They prevent concurrent modifications by ensuring only one client can hold a write lease at a time.

<Callout type="info" title="When to use leases">
  Use leases when multiple clients might modify the same file simultaneously,
  such as collaborative editing or background processing jobs.
</Callout>

## Acquire Lease

<ApiEndpoint
  method="POST"
  path="/v1/nodes/:id/lease"
  description="Acquire a lease on a node. Blocks other writers until released."
>
  <ParameterTable
    type="path"
    params={[
      { name: "id", type: "uuid", required: true, description: "Node ID" },
    ]}
  />
  <ParameterTable
    type="body"
    params={[
      {
        name: "mode",
        type: "string",
        required: true,
        description: '"exclusive" (write) or "shared" (read)',
      },
      {
        name: "durationMinutes",
        type: "number",
        required: false,
        description: "Lease duration in minutes (max 1440)",
      },
    ]}
  />
  <RequestExample
    json={{
      mode: "exclusive",
      durationMinutes: 10,
    }}
  />
  <ResponseExample
    status={201}
    json={{
      id: "lease_abc123",
      nodeId: "550e8400-e29b-41d4-a716-446655440000",
      principalId: "user_123",
      mode: "exclusive",
      expiresAt: "2025-01-15T10:40:00Z",
      acquiredAt: "2025-01-15T10:30:00Z",
    }}
  />
</ApiEndpoint>

## Renew Lease

<ApiEndpoint
  method="PATCH"
  path="/v1/nodes/:id/lease"
  description="Extend the duration of your active lease on a node."
>
  <ParameterTable
    type="path"
    params={[
      { name: "id", type: "uuid", required: true, description: "Node ID" },
    ]}
  />
  <ParameterTable
    type="body"
    params={[
      {
        name: "durationMinutes",
        type: "number",
        required: false,
        description: "New duration from now in minutes",
      },
    ]}
  />
  <RequestExample
    json={{
      durationMinutes: 10,
    }}
  />
  <ResponseExample
    status={200}
    json={{
      id: "lease_abc123",
      expiresAt: "2025-01-15T10:50:00Z",
      renewedAt: "2025-01-15T10:40:00Z",
    }}
  />
</ApiEndpoint>

## Release Lease

<ApiEndpoint
  method="DELETE"
  path="/v1/nodes/:id/lease"
  description="Release your active lease on a node."
>
  <ParameterTable
    type="path"
    params={[
      { name: "id", type: "uuid", required: true, description: "Node ID" },
    ]}
  />
  <ResponseExample status={204} description="No content" json={{}} />
</ApiEndpoint>

## List Leases for Node

<ApiEndpoint
  method="GET"
  path="/v1/nodes/:id/leases"
  description="List all active leases on a node."
>
  <ParameterTable
    type="path"
    params={[
      { name: "id", type: "uuid", required: true, description: "Node ID" },
    ]}
  />
  <ResponseExample
    status={200}
    json={{
      items: [
        {
          id: "lease_abc123",
          principalId: "user_123",
          mode: "exclusive",
          expiresAt: "2025-01-15T10:40:00Z",
          acquiredAt: "2025-01-15T10:30:00Z",
        },
      ],
    }}
  />
</ApiEndpoint>

## List My Leases

<ApiEndpoint
  method="GET"
  path="/v1/leases"
  description="List all active leases held by the current user."
>
  <ResponseExample
    status={200}
    json={{
      items: [
        {
          id: "lease_abc123",
          nodeId: "550e8400-e29b-41d4-a716-446655440000",
          nodeName: "report.pdf",
          principalId: "user_123",
          mode: "exclusive",
          expiresAt: "2025-01-15T10:40:00Z",
        },
      ],
    }}
  />
</ApiEndpoint>

## Example: Safe File Update

<CodeBlock language="typescript" code={`import { RosetClient } from "@roset/sdk";

const client = new RosetClient({ apiKey: "rsk*live*..." });

// Acquire a lease before modifying
// Requesting 'exclusive' access (write lock)
const lease = await client.leases.acquire(fileId, {
durationMinutes: 5,
mode: "exclusive",
});

try {
// Perform modifications
const { uploadUrl, uploadToken } = await client.uploads.init({
nodeId: fileId,
contentType: "application/pdf",
size: newContent.length,
});

await fetch(uploadUrl, { method: "PUT", body: newContent });
await client.uploads.commit({ uploadToken, etag });
} finally {
// Always release the lease
await client.leases.release(fileId);
}`} />
