# Uploads API

The Uploads API handles file data uploads using a two-phase commit pattern. Roset never proxies file data: clients upload directly to storage using signed URLs.

## Upload Flow

1. **Init** : Request a signed upload URL from Roset
2. **Upload** : Upload file data directly to storage (S3/R2/MinIO)
3. **Commit** : Notify Roset that upload is complete with the ETag

## Initialize Upload

<ApiEndpoint
  method="POST"
  path="/v1/uploads/init"
  description="Get a signed URL for uploading file data directly to storage."
>
  <ParameterTable
    type="body"
    params={[
      {
        name: "nodeId",
        type: "uuid",
        required: false,
        description: "Target file node ID (for overwrite)",
      },
      {
        name: "parentId",
        type: "uuid",
        required: false,
        description: "Parent folder ID (for new file)",
      },
      {
        name: "name",
        type: "string",
        required: false,
        description: "File name (for new file)",
      },
      {
        name: "contentType",
        type: "string",
        required: false,
        description: "MIME type of the file",
      },
      {
        name: "size",
        type: "number",
        required: false,
        description: "File size in bytes",
      },
    ]}
  />
  <RequestExample
    json={{
      parentId: "550e8400-e29b-41d4-a716-446655440000",
      name: "report.pdf",
      contentType: "application/pdf",
      size: 1048576,
    }}
  />
  <ResponseExample
    status={200}
    json={{
      uploadUrl: "https://storage.example.com/bucket/key?X-Amz-Signature=...",
      uploadToken: "ut_abc123...",
      nodeId: "550e8400-e29b-41d4-a716-446655440001",
      expiresIn: 3600,
    }}
  />
</ApiEndpoint>

## Commit Upload

<ApiEndpoint
  method="POST"
  path="/v1/uploads/commit"
  description="Finalize an upload after data has been uploaded to storage."
>
  <ParameterTable
    type="body"
    params={[
      {
        name: "uploadToken",
        type: "string",
        required: true,
        description: "Token from init response",
      },
      {
        name: "etag",
        type: "string",
        required: false,
        description: "ETag returned by storage provider",
      },
      {
        name: "size",
        type: "number",
        required: false,
        description: "Confirms size of uploaded file",
      },
    ]}
  />
  <RequestExample
    json={{
      uploadToken: "ut_abc123...",
      etag: '"d41d8cd98f00b204e9800998ecf8427e"',
    }}
  />
  <ResponseExample
    status={200}
    json={{
      node: {
        id: "550e8400-e29b-41d4-a716-446655440001",
        name: "report.pdf",
        type: "file",
        size: 1048576,
        contentType: "application/pdf",
      },
      version: {
        id: 42,
        nodeId: "550e8400-e29b-41d4-a716-446655440001",
        size: 1048576,
        etag: '"d41d8cd98f00b204e9800998ecf8427e"',
        isCurrent: true,
        createdAt: "2025-01-15T10:35:00Z",
      },
    }}
  />
</ApiEndpoint>

## Multipart Uploads

### Get Part URL

<ApiEndpoint
  method="POST"
  path="/v1/uploads/:token/part"
  description="Get a signed URL for a specific part of a multipart upload."
>
  <ParameterTable
    type="query"
    params={[
      {
        name: "partNumber",
        type: "number",
        required: true,
        description: "Part number (1-10000)",
      },
    ]}
  />
  <ResponseExample
    status={200}
    json={{
      uploadUrl: "https://storage.example.com/bucket/key?partNumber=1...",
    }}
  />
</ApiEndpoint>

### Complete Multipart

<ApiEndpoint
  method="POST"
  path="/v1/uploads/:token/complete"
  description="Finalize a multipart upload by providing ETags for all parts."
>
  <RequestExample
    json={{
      parts: [
        { ETag: '"etag1"', PartNumber: 1 },
        { ETag: '"etag2"', PartNumber: 2 },
      ],
    }}
  />
  <ResponseExample
    status={200}
    json={{
      node: { id: "node_123", type: "file" },
      version: { id: 1, size: 5242880 },
    }}
  />
</ApiEndpoint>

## Abort Upload

<ApiEndpoint
  method="DELETE"
  path="/v1/uploads/:token"
  description="Abort a pending upload and clean up resources."
>
  <ResponseExample status={204} description="No content" json={{}} />
</ApiEndpoint>

## Downloads

### Get Download URL

<ApiEndpoint
  method="GET"
  path="/v1/nodes/:id/download"
  description="Get a signed URL for downloading file data."
>
  <ParameterTable
    type="path"
    params={[
      { name: "id", type: "uuid", required: true, description: "File node ID" },
    ]}
  />
  <ParameterTable
    type="query"
    params={[
      {
        name: "versionId",
        type: "string",
        required: false,
        description: "Specific version to download",
      },
      {
        name: "attachment",
        type: "boolean",
        required: false,
        description: "Return Content-Disposition: attachment",
        default: "false",
      },
    ]}
  />
  <ResponseExample
    status={200}
    json={{
      url: "https://storage.example.com/bucket/key?X-Amz-Signature=...",
      contentType: "application/pdf",
      size: 1048576,
      expiresIn: 3600,
    }}
  />
</ApiEndpoint>

### Download by Path

<ApiEndpoint
  method="GET"
  path="/v1/download"
  description="Get a signed download URL using the full file path."
>
  <ParameterTable
    type="query"
    params={[
      {
        name: "path",
        type: "string",
        required: true,
        description: "Full path to file",
      },
      {
        name: "attachment",
        type: "boolean",
        required: false,
        default: "false",
      },
    ]}
  />
  <ResponseExample
    status={200}
    json={{
      url: "https://storage.example.com/bucket/key?...",
      contentType: "image/png",
      size: 2048,
      expiresIn: 3600,
    }}
  />
</ApiEndpoint>
