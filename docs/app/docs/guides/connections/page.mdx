import { Tabs, Tab } from '@/components/tabs'
import { Callout } from '@/components/callout'
import { Steps, Step } from '@/components/steps'

export const metadata = {
  title: 'Storage Connections',
  description: 'Connect your cloud storage buckets to Roset for direct file upload and download via signed URLs.',
}

# Storage Connections

A connection links a cloud storage bucket to Roset. Once connected, Roset can enumerate files in your bucket, issue signed URLs for direct upload and download, and sync file metadata into its catalog -- all without copying or proxying file bytes.

This is central to how Roset works: your data stays in your storage, and Roset manages the metadata, orchestration, and transformation.

## Supported Providers

| Provider | Setup Method | Bucket Types |
|----------|-------------|--------------|
| AWS | CloudFormation role | S3, S3-compatible |
| GCP | Service Account | GCS buckets |
| Azure | Service Principal | Blob containers |
| MinIO | Access Key | MinIO buckets |

## Create a Connection

<Tabs>
<Tab label="TypeScript">
```typescript
import { RosetClient } from '@roset/sdk';

const client = new RosetClient({ apiKey: 'rsk_...' });

// Link an S3 bucket to Roset
const connection = await client.connections.create({
  provider: 's3',
  name: 'Production Bucket',
  bucket: 'my-company-files',
  region: 'us-east-1',
  prefix: 'uploads/',    // only sync files under this prefix
});

console.log(connection.id); // "conn-abc123"
```
</Tab>
<Tab label="Python">
```python
from roset import Client

client = Client(api_key="rsk_...")

# Link an S3 bucket to Roset
connection = client.connections.create(
    provider="s3",
    name="Production Bucket",
    bucket="my-company-files",
    region="us-east-1",
    prefix="uploads/",    # only sync files under this prefix
)

print(connection["id"])  # "conn-abc123"
```
</Tab>
<Tab label="cURL">
```bash
# Link an S3 bucket to Roset
curl -X POST https://api.roset.dev/v1/connections \
  -H "Authorization: ApiKey rsk_..." \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "s3",
    "name": "Production Bucket",
    "bucket": "my-company-files",
    "region": "us-east-1",
    "prefix": "uploads/"
  }'
```
</Tab>
</Tabs>

## Test a Connection

Before syncing, verify that Roset can reach your bucket and has the required permissions.

<Tabs>
<Tab label="TypeScript">
```typescript
// Verify Roset can access the bucket
const result = await client.connections.test('conn-abc123');
console.log(result); // { success: true }
```
</Tab>
<Tab label="Python">
```python
# Verify Roset can access the bucket
result = client.connections.test("conn-abc123")
print(result)  # {"success": True}
```
</Tab>
<Tab label="cURL">
```bash
# Verify Roset can access the bucket
curl -X POST https://api.roset.dev/v1/connections/conn-abc123/test \
  -H "Authorization: ApiKey rsk_..."
```
</Tab>
</Tabs>

## Sync Files

Syncing enumerates files from your bucket and creates **node** records in Roset. This is a metadata-only operation -- Roset reads the file listing from your bucket but does not transfer any file bytes.

<Tabs>
<Tab label="TypeScript">
```typescript
// Enumerate bucket contents and create node records in Roset
const sync = await client.connections.sync('conn-abc123');
console.log(sync); // { synced_count: 142 }
```
</Tab>
<Tab label="Python">
```python
# Enumerate bucket contents and create node records in Roset
sync = client.connections.sync("conn-abc123")
print(sync)  # {"synced_count": 142}
```
</Tab>
<Tab label="cURL">
```bash
# Enumerate bucket contents and create node records in Roset
curl -X POST https://api.roset.dev/v1/connections/conn-abc123/sync \
  -H "Authorization: ApiKey rsk_..."
```
</Tab>
</Tabs>

## Browse Nodes

After syncing, browse files and folders through the nodes API. Nodes are metadata records that mirror your bucket's directory structure.

<Tabs>
<Tab label="TypeScript">
```typescript
// List root-level nodes for a connection
const { nodes } = await client.nodes.list({
  connection_id: 'conn-abc123',
});

for (const node of nodes) {
  console.log(`${node.type} ${node.name} (${node.size_bytes} bytes)`);
}

// Get a single node's metadata
const node = await client.nodes.get('node-xyz');

// Get a signed download URL (valid for 1 hour, direct from your bucket)
const download = await client.nodes.download('node-xyz');
console.log(download.url);
```
</Tab>
<Tab label="Python">
```python
# List root-level nodes for a connection
result = client.nodes.list(connection_id="conn-abc123")
for node in result["nodes"]:
    print(f"{node['type']} {node['name']} ({node['size_bytes']} bytes)")

# Get a single node's metadata
node = client.nodes.get("node-xyz")

# Get a signed download URL (valid for 1 hour, direct from your bucket)
download = client.nodes.download("node-xyz")
print(download["url"])
```
</Tab>
<Tab label="cURL">
```bash
# List nodes from a connected bucket
curl "https://api.roset.dev/v1/nodes?connection_id=conn-abc123" \
  -H "Authorization: ApiKey rsk_..."

# Get a signed download URL (direct from your bucket)
curl https://api.roset.dev/v1/nodes/node-xyz/download \
  -H "Authorization: ApiKey rsk_..."
```
</Tab>
</Tabs>

## Manage Connections

<Tabs>
<Tab label="TypeScript">
```typescript
// List all connections for your organization
const { connections } = await client.connections.list();

// Get a specific connection's details
const conn = await client.connections.get('conn-abc123');

// Delete a connection (removes metadata link only -- your bucket is unaffected)
await client.connections.delete('conn-abc123');
```
</Tab>
<Tab label="Python">
```python
# List all connections for your organization
result = client.connections.list()

# Get a specific connection's details
conn = client.connections.get("conn-abc123")

# Delete a connection (removes metadata link only -- your bucket is unaffected)
client.connections.delete("conn-abc123")
```
</Tab>
</Tabs>

<Callout type="note" title="Metadata Only">
Deleting a connection removes the metadata records from Roset. Your files in the cloud storage bucket are never modified or deleted by Roset.
</Callout>

## Next Steps

- [API Reference](/docs/reference/api#connections) -- full connection and node endpoint documentation.
- [Webhooks](/docs/guides/webhooks) -- get notified when syncs complete.
