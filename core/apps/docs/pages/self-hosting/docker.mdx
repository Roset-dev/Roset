# Local Development

Run Roset locally with Docker.

## Prerequisites

- Docker & Docker Compose
- Node.js 18+
- pnpm

## Quick Start

```bash
cd roset/api

# Start infrastructure
docker compose up -d

# Install dependencies
pnpm install

# Run migrations
pnpm run migrate

# Start API
pnpm run dev
```

## Services

| Service | Port | Credentials |
|---------|------|-------------|
| API | 3000 | - |
| PostgreSQL | 5432 | postgres/postgres |
| Redis | 6379 | - |
| MinIO | 9000 | minioadmin/minioadmin |
| MinIO Console | 9001 | minioadmin/minioadmin |

## Environment Variables

Copy `.env.example` to `.env`:

```bash
cp .env.example .env
```

Key variables:

```env
# Server
PORT=3000
HOST=0.0.0.0

# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/roset

# Redis
REDIS_URL=redis://localhost:6379

# S3/MinIO
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY_ID=minioadmin
S3_SECRET_ACCESS_KEY=minioadmin
S3_REGION=us-east-1
S3_FORCE_PATH_STYLE=true

# JWT
JWT_ISSUER=https://roset.io
JWKS_URL=https://your-auth-provider/.well-known/jwks.json

# Signed URLs
SIGNED_URL_EXPIRES_IN=3600
```

## Seeding Test Data

```sql
-- Connect: docker exec -it roset-postgres psql -U postgres -d roset

-- Create tenant
INSERT INTO tenants (id, name, slug) VALUES 
  ('00000000-0000-0000-0000-000000000001', 'Demo', 'demo');

-- Create mount
INSERT INTO mounts (id, tenant_id, provider, bucket, region, is_default) VALUES 
  ('00000000-0000-0000-0000-000000000002', 
   '00000000-0000-0000-0000-000000000001',
   'minio', 'demo-bucket', 'us-east-1', true);

-- Create root node
INSERT INTO nodes (tenant_id, mount_id, parent_id, name, type) VALUES 
  ('00000000-0000-0000-0000-000000000001',
   '00000000-0000-0000-0000-000000000002',
   NULL, '', 'folder');
```

## Running Tests

```bash
# Start test database
docker compose -f docker-compose.test.yml up -d

# Run tests
pnpm test

# Run specific test file
pnpm test -- tests/nodes.test.ts
```

## Switching to Production

Change these environment variables:

```env
S3_ENDPOINT=https://s3.us-east-1.amazonaws.com
S3_FORCE_PATH_STYLE=false
S3_ACCESS_KEY_ID=AKIA...
S3_SECRET_ACCESS_KEY=...
```

The same code works with AWS S3, Cloudflare R2, and MinIO.
